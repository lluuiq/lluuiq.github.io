---
title: 全自动博客的部署实现
date: 2020-02-23 09:09:25 
comments: true
toc: true
top: false

categories: 
- [笔记,博客]
tags: [hexo,github,webhook]
---
# 前言

不使用github pages，改为自己的服务器。将代码托管到gtihub，使用webhook实现github与服务器同步推送代码，并且安装hexo-admin来实现后台管理与服务器到github上的推送。

<!-- more -->

# 购买服务器

服务器商千千万，自行挑选一个靠谱的。

**注意：国内各服务商有学生优惠套餐，但是只能购买大陆服务器，且大陆服务器需要备案才能使用。但是便宜稳定。**

进入服务商的购买页面，选择配置。

若是一键选择套餐购买，需要选择地区、选择服务器的配置、选择服务器镜像系统、服务器带宽(越大则服务器能承受的压力越大)、购买时长。

若是自定义配置，需要选择购买的计时方式、配置的详细选择，更多的系统选择以及自定义镜像、存储空间。

总结就是越强越贵，时间越长越贵。个人博客不需要非常好的配置，推荐系统选择linux

**注意：大陆服务器需要至少购买3个月时长才可以进行备案。**

<fancybox>

![mark](http://blogimg.wa2000.cn/blog/20190809/mKBOzXNXQ0pb.png?imageslim)

</fancybox>

假如是国外服务器，则购买后可以直接进行部署了。如果是头铁选了国内，则需要先进行备案(大概20天左右。备案流程放到最后。)

我使用的宝塔控制面板，简单方便无脑。安装宝塔后，可以在控制面板进行操作来操作自己的服务器。



注：若服务器操作过程出现无法挽回的问题，可以在服务器控制台重装系统。

![mark](http://blogimg.wa2000.cn/blog/20190809/2mJcMoW43EBy.png?imageslim)

# 连接服务器

首先下载putty、xhell等连接工具，我使用的是finalshell，用哪个都可以，原理都一样，用服务器商自带的登陆功能也可以。打开后界面如图。

![mark](http://blogimg.wa2000.cn/blog/20190727/M9gdcu7JaND6.png?imageslim)

点击文件夹，新建一个连接，选择SSH连接

![mark](http://blogimg.wa2000.cn/blog/20190727/vKFE926oPxYh.png?imageslim)

名称自定义，主机为上一步的ip地址。填写完后点击确定。

(国外服务器可勾选智能加速，国内则不勾选)此时我使用的是美国服务器，所以勾选了海外加速。

![mark](http://blogimg.wa2000.cn/blog/20190809/IncJQOCBsFnw.png?imageslim)

可以看到新建了一个服务器连接，ssr为刚刚自定义的名称，后面有ip地址和端口号，和服务器主机名。

![mark](http://blogimg.wa2000.cn/blog/20190809/UokWkRraQ6vq.png?imageslim)

双击该连接，进入服务器，连接成功出现如图所示界面。

![mark](http://blogimg.wa2000.cn/blog/20190809/5yro2YVgGSAz.png?imageslim)

如果出现该窗口

![mark](http://blogimg.wa2000.cn/blog/20190727/Uu2as5e68pmD.png?imageslim)

点接受并保存。

# 配置服务器

## 安装宝塔面板

根据官方教程进行安装。

> [宝塔Linux面板安装教程](https://www.bt.cn/bbs/thread-19376-1-1.html)
>
> 若安装完成不能使用，则需要放行端口：
>
> 腾讯云：https://www.bt.cn/bbs/thread-1229-1-1.html
>
> 阿里云：https://www.bt.cn/bbs/thread-2897-1-1.html  
>
> 华为云：https://www.bt.cn/bbs/thread-3923-1-1.html 

进入服务器，根据自身系统输入安装命令，命令失效则看官方教程，有备用命令

**Centos安装命令：**

```
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

**Ubuntu/Deepin安装命令：**

```
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

**Debian安装命令：**

```
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && bash install.sh
```

**Fedora安装命令:**

```
wget -O install.sh http://download.bt.cn/install/install_6.0.sh && bash install.sh
```

以cenOS为例：

输入命令进行安装

<fancybox>

![mark](http://blogimg.wa2000.cn/blog/20190809/Ko7lhpGEEBAK.png?imageslim)

  </fancybox>

输入y，安装宝塔，然后稍等片刻

![mark](http://blogimg.wa2000.cn/blog/20190809/hFIv0SYBqxNV.png?imageslim)

如图安装完成，会显示控制面板的url以及用户名和密码

<fancybox>

![mark](http://blogimg.wa2000.cn/blog/20190809/8YkIo4YM1rwx.png?imageslim)

</fancybox>

安装完成后，就可以关闭finalShell了，打开浏览器，输入该地址，并输入刚刚显示的用户名和密码，进入面板

这里建议进入后修改登陆面板的帐号与密码，不使用默认生成的。并且将面板的网址保存起来，方便以后直接输入网址进入面板。

![mark](http://blogimg.wa2000.cn/blog/20190809/PHzFAoOtToYH.png?imageslim)

进入面板后，会出现如下提示，进行安装软件。可以根据需求进行安装，也可以直接点一键安装，推荐LNMP，且选择极速安装，编译安装太慢。

![mark](http://blogimg.wa2000.cn/blog/20190809/GHm01iiYxoi8.png?imageslim)

## 绑定域名到服务器

宝塔面板安装完成后，在导航栏点击网站，选择添加站点。

![mark](http://blogimg.wa2000.cn/blog/20190809/g4KK3VygrHgT.png?imageslim)

设置如下，在域名处填写自己的域名，可填写多个 （填写进的域名在解析完成后可以访问到该网站）

![mark](http://blogimg.wa2000.cn/blog/20200220/cJedfpWTqU7G.png?imageslim)

生成站点后，点击网站名或者后面的设置，可以进入站点设置来添加一些新的域名以及二级域名等等。

![mark](http://blogimg.wa2000.cn/blog/20190809/dukEJTEkeDBX.png?imageslim)

**其中abc为自定义的二级域名，想不想设置随意。设置了就需要在解析时填写对应的主机记录。**

![mark](http://blogimg.wa2000.cn/blog/20200220/pshctiRCDIrz.png?imageslim)

点击添加后如下，这样用户可以通过以下域名访问到该服务器部署的网站，如果不想让github.io的地址也访问到该服务器，可以删除。

**添加的域名需要解析到服务器才可以正常使用。**

![mark](http://blogimg.wa2000.cn/blog/20190809/jXpqzS202Bdu.png?imageslim)

添加完成后关闭设置即可。

**最后到域名管理处。进行解析。**解析步骤和[解析域名](# 解析域名)一样。添加记录如下

- 记录值：www和@各添加一次，
- 记录类型：选A
- 线路类型：默认
- 记录值：你的服务器IP地址

结果如下（若有自定义二级域名等等，需要再添加上。）

![mark](http://blogimg.wa2000.cn/blog/20190809/0H0r7NMlAbnc.png?imageslim)

等待几分钟生效，即可通过域名访问该服务器。

# 将源代码保存到github

## 创建分支

在仓库中的文件列表的左上方，点击Branch。

![mark](http://blogimg.wa2000.cn/blog/20200220/vKjTkYWrK8KD.png?imageslim)

搜索 source （分支名，自定义），会提示未找到，是否创建，点击即可创建该分支

![mark](http://blogimg.wa2000.cn/blog/20200220/AQ6FixHkRjvU.png?imageslim)

## 设置新建分支为默认分支

进入设置，左边的列表中选择 Branches，默认分支为master，改为新建的分支，然后点击Update更新。

![mark](http://blogimg.wa2000.cn/blog/20200220/7pI4wicXk16d.png?imageslim)

## 设置本地同步

首先随便找个地方新建一个文件夹，将你的仓库克隆下来。

打开新建的文件夹，右键空白处点击`Git Bash Here`

然后输入下方命令克隆文件

```
git clone 【你的仓库地址】
```

仓库地址获取方法：

![mark](http://blogimg.wa2000.cn/blog/20200223/Q1pkl9KP2JBF.png?imageslim)

点击红框内的按钮复制，然后粘贴到clone后面即可，用空格与clone隔开。

克隆完成后，该文件夹内会出现`【你的用户名】.github.io`文件夹，进去拷贝`.git`文件夹到本地的博客根目录，然后这个新建的文件夹就可以删除了。

接下来在博客根目录右键空白处，打开git bash，输入下方命令，警告不用理会，若没出现报错就没问题。

会需要github的帐号密码，填一下就OK了。

```
git remote add origin 【你的仓库地址】
git add .
git commit -m "【描述，随便写】"
git push origin 【你的保存源代码的分支名】
```

描述部分的效果如图，会将内容显示在该分支上。

![mark](http://blogimg.wa2000.cn/blog/20200223/GggAj5iv7u21.png?imageslim)

每次推送时，输入的描述都会在这次推送时更新的文件后面显示出来。

接下来每次想保存时，输入下方指令即可，

```
git add .
git commit -m "【描述】"
git push
```

但每次都要输入这么多很麻烦，可以创建一个脚本文件，在博客根目录下新建一个txt文本文件，名字随意自己能知道是保存用的就行，将上方三条指令写进去，描述写好后以后固定都是这个，然后将文件改为`.sh`结尾。也可以直接建一个`.sh`尾缀文件，然后用编辑器打开写入。这样以后每次点一下这个脚本文件就会自动执行上面三条指令，完成推送。

本地同步到github就完成了，但要注意的是只保存了关键文件，如主题、文章、配置等。

node_modules文件夹和public文件夹是没有保存上去的，public文件夹是生成的静态页面，不需要保存，若迁移后直接生成就有了。

node_modules文件夹存放着需要用到的插件，如果想保存的话，打开`.gitignore`文件，把里面的node_modules删掉保存即可，但是这样会造成每次保存都需要很久时间，因为里面东西太多了，看个人需要决定是否需要保存。

生成的静态页面是会推送到master分支的，只要配置文件里面的deploy里的branch的值是master的话

![mark](http://blogimg.wa2000.cn/blog/20200223/rQWYspvqQ5Su.png?imageslim)

配置完成后，若以后要迁移到其他的服务器或者电脑上，只需要安装好git、Node.js、hexo，然后使用`hexo init`命令初始化一个根目录，再克隆下来就行了，若不指定克隆分支的话，会克隆默认分支，即设置好的保存博客源代码的分支。



# 将博客同步到服务器

## 在服务器上部署hexo

关于CentOS的安装git、Node.js我遇到一些问题，参考了下面两篇文章完美解决，故这里就不说安装方法了，直接看这两篇就行了。

CentOS安装Git参考链接：
https://www.cnblogs.com/imyalost/p/8715688.html

**注**：Hexo需要10版本以上才能支持，默认安装的话版本开头为6，需要安装最新版本才可以，我就用默认安装Node.js的方法结果最后hexo安装失败。

CentOS安装最新版Node.js参考链接：

https://www.jianshu.com/p/4a9449506924

安装hexo指令：

```
npm install hexo-cli -g
```

![mark](http://blogimg.wa2000.cn/blog/20200223/nR89OV9XOOVh.png?imageslim)

警告不用理会。

## 克隆保存在github上的博客代码

通过cd命令切换到想保存博客根目录的文件夹下，例如我打算把博客的根目录放在 /www下，则输入`cd /www`，

然后克隆在github上的博客源代码，例如我的命令为

`git clone https://github.com/lluuiq/lluuiq.github.io.git`，后面是仓库地址，改为自己的。

```
git clone 【仓库地址】
```

这样在输入该指令的文件夹下会出现【yourusername】.github.io的文件夹，里面放着博客的源代码。

若想改个名字的话，在包含根目录的文件夹下（我的是/www）输入下面指令

```
mv 【yourusername】.github.io 【newname】
```

我将文件夹名称改为wa2000，下面的wa2000文件夹都是博客根目录。

在服务器上的hexo根目录已经建成，接下来就是同步github上的源代码仓库，使得当github仓库的文件更新时，服务器上的博客源代码也会同步更新。

## 服务器上的hexo同步github

### 安装宝塔WebHook

在宝塔面板导航栏点击软件商店。搜索 `webhook` 点击安装。

![mark](http://blogimg.wa2000.cn/blog/20190809/vAEwro2DcWbx.png?imageslim)

### 宝塔配置webhook

安装完成后，点击设置，(可以勾选首页显示。)

![mark](http://blogimg.wa2000.cn/blog/20190809/cdjJbm1Q5ULW.png?imageslim)

点击添加，名称随意，执行脚本先随便填写一点内容，点击提交后再编辑脚本。

（若出现编辑不能保存的情况，则删除重建，将代码直接粘贴进执行脚本然后创建）

![mark](http://blogimg.wa2000.cn/blog/20200220/Q3adMpGclpAM.png?imageslim)

添加完成后点击编辑，删除原来随意填写的内容，添加如下代码并修改gitHttp。

个人的配置（参照修改）

git项目路径：`gitPath="/www/wa2000"`

git网址：`gitHttp="https://github.com/lluuiq/lluuiq.github.io.git"`

分支名：`source`

```
#!/bin/bash
echo ""
#输出当前时间
date --date='0 days ago' "+%Y-%m-%d %H:%M:%S"
echo "Start"
#git项目路径
gitPath="【你的博客根目录地址】"
#git 网址
gitHttp="【你的仓库地址】"

echo "Web站点路径：$gitPath"

#判断项目路径是否存在
if [ -d "$gitPath" ]; then
        cd $gitPath
        #判断是否存在git目录
        if [ ! -d ".git" ]; then
                echo "在该目录下克隆 git"
                git clone $gitHttp gittemp
                mv gittemp/.git .
                rm -rf gittemp
        fi
        #拉取最新的项目文件
        git reset --hard origin/【你的分支名】
        git pull
        #设置目录权限
        chown -R www:www $gitPath
        echo "End"
        exit
else
        echo "该项目路径不存在"
        echo "End"
        exit
fi
```

然后点击查看密钥

![image-20200223100058754](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223100058754.png)

复制下面的URL，将后面的`&param=aaa`删掉（不删也可以）。

![image-20200223100134317](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223100134317.png)

到github的仓库的设置里，点击左边的Webhooks，添加webhook

![image-20200223100321336](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223100321336.png)

然后将复制的URL拷贝进去，将其中的密钥（链接中Key=后面，或者在查看密钥处复制也行）拷贝到下方，然后点击Add webhook添加。

![image-20200223100418080](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223100418080.png)

这样钩子会自动拉取source分支的代码到gitPath路径下，实现代码同步。

### 创建站点

如图点击添加站点。

![image-20200223100855831](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223100855831.png)

添加域名可以加前缀，但加了前缀也要加入对应的解析。根目录后面一定要是public文件夹，生成的静态页面会保存在该文件夹中，只有将该文件夹设为根目录网站才会正常显示，最后点击提交即可创建。

![image-20200223101102881](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223101102881.png)

然后回到服务器，安装必要包

```
npm install hexo --save
npm install --save hexo-deployer-git
```

输入github的用户名与密码

```
git config --global user.email "【github邮箱】"
git config --global user.name "【github用户名】"
```

配置SSH免去每次推送都要帐号密码，任意地方输入

```
ssh-keygen -t rsa
```

中间都按回车就行了，然后到ssh存放的地方

```text
cd ~/.ssh
vim id_rsa.pub
```

打开id_rsa.pub后，复制里面的公钥（用finalshell的话直接在下方的文件目录里双击打开也可以）

然后到如图地方添加公钥

![image-20200223104908346](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223104908346.png)

![image-20200223105000475](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223105000475.png)

然后到仓库的地方，复制ssh地址

![image-20200223105233235](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223105233235.png)

![image-20200223105246770](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223105246770.png)

（若本来就是ssh地址则跳过）打开根目录的配置文件_config.yml，将deploy下的repository改为ssh地址。

![image-20200223105848913](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223105848913.png)

在博客的根目录下生成静态页面并尝试推送到github

```
hexo clean
hexo g
hexo d
```

注：若出现下方情况则使用下方命令删除`.user.ini`

```
chattr -i 【.user.ini路径】
rm -rf 【.user.ini路径】
```

![image-20200223104030322](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223104030322.png)

![image-20200223104105826](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223104105826.png)

若出现下方情况则修改ssh配置

![image-20200223110925367](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223110925367.png)

```
vim /etc/ssh/sshd_config
```

找到 RSAAuthentication与PubkeyAuthentication，将注释去掉，并确定AuthorizedKeysFile后面为`.ssh/authorized_keys`且可用。

![image-20200223110659159](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223110659159.png)

然后重启ssh服务。

```
/sbin/service sshd restart
```

再次执行`hexo d`可能会出现下方警告

![image-20200223111201894](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223111201894.png)

该警告是让你将github的IP加入host，可以无视，也可以加进去去掉警告。

```
vim /etc/hosts
```

然后在里面加入`【警告中的IP地址】 github.com`，保存并退出即可。

![image-20200223111431982](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223111431982.png)

清除、生成、推送都成功后，重启宝塔面板

```
/etc/init.d/bt restart
```

重启后，在本地使用推送将博客源代码推到github时，服务器上会自动拉取进行同步。

![image-20200223042942382](C:%5CUsers%5C84452%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200223042942382.png)

接下来就是在服务器上开启远程后台管理了。